<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">event-fix.patch on Ticket #2565 – Attachment – jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/PPcE5K0pdi.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          


<div class="flex-column attachment">
  <nav class="content-nav">
    <ul class="flex-row">
      <li>
        <a href="/ticket/2565">Back to Ticket #2565</a>
      </li>
    </ul>
  </nav>

  <h1>
    <a href="/ticket/2565">Ticket #2565</a>: event-fix.patch
  
  <hr>

  <div class="attachment-info">
    <h6>File event-fix.patch, 8.1 KB (added by diego, March 27, 2008 03:13AM UTC)</h6>
    
      <p>Patch for the &quot;event.js&quot; source file</p>
    
  </div>

  
    <div class="attachment-preview">
      
      <pre class="language-patch" tabindex="0"><code class="language-patch">--- event.js.orig	2008-03-26 18:52:33.000000000 +0100
+++ event.js	2008-03-26 23:22:57.000000000 +0100
@@ -236,21 +236,24 @@
 	},
 
 	handle: function(event) {
-		// returned undefined or false
-		var val;
+		// val is returned undefined or false
+		var j, args, events, handler, handlers, parts, ret, val;
 
 		// Empty object is for triggered events with no data
 		event = jQuery.event.fix( event || window.event || {} ); 
 
 		// Namespaced event handlers
-		var parts = event.type.split(".");
-		event.type = parts[0];
-
-		var handlers = jQuery.data(this, "events") && jQuery.data(this, "events")[event.type], args = Array.prototype.slice.call( arguments, 1 );
+		parts = event.type.split(".");
+		if (event.type != parts[0])
+			event.type = parts[0];
+
+		events = jQuery.data(this, "events");
+		handlers = events && events[event.type];
+		args = Array.prototype.slice.call( arguments, 1 );
 		args.unshift( event );
 
-		for ( var j in handlers ) {
-			var handler = handlers[j];
+		for ( j in handlers ) {
+			handler = handlers[j];
 			// Pass in a reference to the handler function itself
 			// So that we can later remove it
 			args[0].handler = handler;
@@ -258,7 +261,7 @@
 
 			// Filter the functions by class
 			if ( !parts[1] && !event.exclusive || handler.type == parts[1] ) {
-				var ret = handler.apply( this, args );
+				ret = handler.apply( this, args );
 
 				if ( val !== false )
 					val = ret;
@@ -278,64 +278,166 @@
 		return val;
 	},
 
-	fix: function(event) {
-		// store a copy of the original event object 
-		// and clone to set read-only properties
-		var originalEvent = event;
-		event = jQuery.extend({}, originalEvent);
-		
-		// add preventDefault and stopPropagation since 
-		// they will not work on the clone
-		event.preventDefault = function() {
-			// if preventDefault exists run it on the original event
-			if (originalEvent.preventDefault)
-				originalEvent.preventDefault();
-			// otherwise set the returnValue property of the original event to false (IE)
-			originalEvent.returnValue = false;
-		};
-		event.stopPropagation = function() {
-			// if stopPropagation exists run it on the original event
-			if (originalEvent.stopPropagation)
-				originalEvent.stopPropagation();
-			// otherwise set the cancelBubble property of the original event to true (IE)
-			originalEvent.cancelBubble = true;
-		};
-		
-		// Fix target property, if necessary
-		if ( !event.target )
-			event.target = event.srcElement || document; // Fixes #1925 where srcElement might not be defined either
-				
-		// check if target is a textnode (safari)
-		if ( event.target.nodeType == 3 )
-			event.target = originalEvent.target.parentNode;
-
-		// Add relatedTarget, if necessary
-		if ( !event.relatedTarget && event.fromElement )
-			event.relatedTarget = event.fromElement == event.target ? event.toElement : event.fromElement;
-
-		// Calculate pageX/Y if missing and clientX/Y available
-		if ( event.pageX == null && event.clientX != null ) {
-			var doc = document.documentElement, body = document.body;
-			event.pageX = event.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc.clientLeft || 0);
-			event.pageY = event.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc.clientTop || 0);
-		}
-			
-		// Add which for key events
-		if ( !event.which && ((event.charCode || event.charCode === 0) ? event.charCode : event.keyCode) )
-			event.which = event.charCode || event.keyCode;
-		
-		// Add metaKey to non-Mac browsers (use ctrl for PC's and Meta for Macs)
-		if ( !event.metaKey && event.ctrlKey )
-			event.metaKey = event.ctrlKey;
-
-		// Add which for click: 1 == left; 2 == middle; 3 == right
-		// Note: button is not normalized, so don't use it
-		if ( !event.which && event.button )
-			event.which = (event.button & 1 ? 1 : ( event.button & 2 ? 3 : ( event.button & 4 ? 2 : 0 ) ));
-			
-		return event;
-	},
-	
+	// create a new event object to be able to set
+	// properties that normally are just read-only
+	create: function(e, target, source) {
+
+		// need to set defult values
+		return e.originalEvent ? e : {
+
+			type: e.type,
+
+			pageX: e.pageX || 0,
+			pageY: e.pageY || 0,
+
+			clientX: e.clientX || 0,
+			clientY: e.clientY || 0,
+
+			screenX: e.screenX || 0,
+			screenY: e.screenY || 0,
+
+			// target is a parameter
+			target: target || window,
+
+			altKey: e.altKey || false,
+			button: e.button || false,
+			ctrlKey: e.ctrlKey || false,
+			metaKey: e.metaKey || false,
+			shiftKey: e.shiftKey || false,
+
+			details: e.details || null,
+			wheelDelta: e.wheelDelta || 0,
+
+			bubbles: e.bubbles || true,
+			cancelable: e.cancelable || true,
+
+			eventPhase: e.eventPhase || 0,
+			timeStamp: e.timeStamp || (new Date()).getTime(),
+
+			// target and source are parameters
+			relatedTarget: e.relatedTarget || target || null,
+			currentTarget: e.currentTarget || source || null,
+
+			view: e.view || window,
+
+			relatedNode: e.relatedNode || null,
+
+			prevValue: e.prevValue || null,
+			newValue: e.newValue || null,
+
+			attrName: e.attrName || '',
+			attrChange: e.attrChange || false,
+
+			data: e.data || null,
+			handler: e.handler || null,
+			exclusive: e.exclusive || false,
+
+			// reference to the original event
+			originalEvent: e
+
+ 		};
+
+	},
+
+	fix: function(e, o) {
+
+		// cache this
+		var root = document.documentElement, body = document.body;
+
+		// optimized using lazy function definition
+		// and recreating a new event object template
+
+		if ( document.createEventObject ) {
+
+			jQuery.event.fix = function(e, o) {
+
+				var ev = e;
+
+				ev.target = ev.target || ev.srcElement || window;
+
+				// prevent the execution of the default action
+				ev.preventDefault = ev.preventDefault || function() {
+					// set the returnValue property of
+					// the original event to false (IE)
+					e.returnValue = false;
+				};
+
+				// stop the event bubbling up to other elements
+				ev.stopPropagation = ev.stopPropagation || function() {
+					// set the cancelBubble property of
+					// the original event to true (IE)
+					e.cancelBubble = true;
+				};
+
+				// check if target is a textnode (safari)
+				if ( ev.target.nodeType == 3 ) {
+					ev.target = ev.target.parentNode;
+				}
+
+				// Add relatedTarget, if necessary
+				ev.relatedTarget = ev.relatedTarget || (ev.fromElement == ev.target ? ev.toElement : ev.fromElement);
+
+				// Calculate pageX/Y if missing and clientX/Y available
+				ev.pageX = ev.pageX || (ev.clientX + (root && root.scrollLeft || body && body.scrollLeft || 0) - (root.clientLeft || 0));
+				ev.pageY = ev.pageY || (ev.clientY + (root && root.scrollTop || body && body.scrollTop || 0) - (root.clientTop || 0));
+
+				// Add which for key events
+				ev.which = ev.which || ev.charCode || ev.keyCode;
+
+				// Add metaKey to non-Mac browsers (use ctrl for PC's and Meta for Macs)
+				ev.metaKey = ev.metaKey || ev.ctrlKey;
+
+				// Add which for click: 1 == left; 2 == middle; 3 == right
+				// Note: button is not normalized, so don't use it
+				ev.which = ev.which || (ev.button & 1 ? 1 : ( ev.button & 2 ? 3 : ( ev.button & 4 ? 2 : 0 ) ));
+
+				// return the writable cloned event
+				return ev;
+			}
+
+		} else {
+
+			jQuery.event.fix = function(e, o) {
+
+				var ev = e;
+
+				// is it a custom event
+				if ( !ev.initEvent ) {
+
+					// create a mirror event
+					ev = jQuery.event.create(e, e.target, o);
+
+					// add preventDefault and stopPropagation since
+					// they will not work on the clone event object
+
+					// prevent the execution of the default action
+					ev.preventDefault = ev.preventDefault || function() {
+						// if preventDefault exists run it on the original event
+						if (e.preventDefault)
+							e.preventDefault();
+					};
+
+					// stop the event bubbling up to other elements
+					ev.stopPropagation = ev.stopPropagation || function() {
+						// if stopPropagation exists run it on the original event
+						if (e.stopPropagation)
+							e.stopPropagation();
+					};
+
+					// check if target is a textnode
+					if ( ev.target.nodeType == 3 ) {
+						ev.target = ev.target.parentNode;
+					}
+
+				}
+
+				return ev;
+			}
+		}
+
+		return jQuery.event.fix(e, o);
+	},
+
 	special: {
 		ready: {
 			setup: function() {</code></pre>
    </div>
  

  <div class="attachment-download flex-column flex-center">
    <h3>Download in other formats:</h3>
    <a class="attachment-download-link" download="" href="/raw-attachment/ticket/2565/event-fix.patch">Original Format</a>
  </div>
</h1></div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

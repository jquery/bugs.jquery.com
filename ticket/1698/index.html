<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#1698 (Scripts should be executed after HTML is inserted to DOM) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/1697/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/1699/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#1698</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(fixed)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened September 20, 2007 03:30PM UTC</p>
      
        <p>Closed October 17, 2007 10:44PM UTC</p>
      
      
        <p>Last modified March 15, 2012 07:42PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">Scripts should be executed after HTML is inserted to DOM</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        diz
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        major
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/1.2.2">1.2.2</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>core</td>
      
        <th>Version:</th>
      
      <td>1.2.1</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>Hello!</p><p>I previously posted this ticket: <a href="http://dev.jquery.com/ticket/1598" class="ext-link"><span class="icon"></span>http://dev.jquery.com/ticket/1598</a>, but by solving that problem for v1.2.1, another one has been created:</p><p>When HTML code is added to the DOM (by domManip function), the &lt;SCRIPT&gt; elements it contains should be automatically executed. The problem is that this execution now takes place <strong>before</strong> the HTML code is inserted!</p><p>I corrected this behavior within jQuery 1.2.1, so that the <a href="/wiki/JavaScript">JavaScript</a> code is executed <strong>after</strong> the DOM manipulation, here is my code from line 385 of the full version:</p><pre class="wiki">
	domManip: function(args, table, dir, fn) {
		var clone = this.length &gt; 1, a; 

		return this.each(function(){
			if ( !a ) {
				a = jQuery.clean(args, this.ownerDocument);
				if ( dir &lt; 0 )
					a.reverse();
			}

			var obj = this;

			if ( table && jQuery.nodeName(this, "table") && jQuery.nodeName(a[0], "tr") )
				obj = this.getElementsByTagName("tbody")[0] || this.appendChild(document.createElement("tbody"));

			jQuery.each( a, function(){
				var elem = clone ? this.cloneNode(true) : this;
				
				// Changes start from here ========================================
				var script = extractScript(-1, elem);
				fn.call( obj, elem );
				if (script !== false)
				    evalScript(script);
			});
		});
	}
};

function extractScript(i, elem) {
	if ( jQuery.nodeName(elem, "script") ) {
		if ( elem.parentNode )
			elem.parentNode.removeChild(elem);
		
		// Don't need to return a jQuery object if it was a recursive call
		if (i == -1)
			return jQuery(elem);
		else
		    return;
	
	} else if ( elem.nodeType == 1 )
		return jQuery("script", elem).each(extractScript);
	
	return false;
}

function evalScript(script) {
	script.each(function() {
		if ( this.src )
			jQuery.ajax({ url: this.src, async: false, dataType: "script" });
		else
			jQuery.globalEval( this.text || this.textContent || this.innerHTML || "" );
	});
}
</pre><p>What I did, was to split the current evalScript function into two function: one that extracts (and removes) the scripts and one that evaluates what has been extracted. This way, the DOM manipulation can be done after the scripts have been extracted (else Firefox will execute the script twice), but before the scripts are executed.</p><p>I didn't extensively test my correction. It solves the differences with <a href="/wiki/JavaScript">JavaScript</a> execution for the different browsers in my case. But I tried to make it in the jQuery logic, so that it can be added easily to the next build after having been reviewed by you. ;-)</p><p>Thanks for your work!</p><p>Gabriel</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (2)</summary>

  <ul class="ticket-attachments">
    
      <li>
        <a href="/attachment/ticket/1698/jquery-20071012.patch/index.html">jquery-20071012.patch</a> (2.1 KB) - added by diz
        <strong>October 12, 2007 03:59PM UTC</strong>.<br>
        <p>New patch that should correct kennydee's test case.</p>
      </li>
    
      <li>
        <a href="/attachment/ticket/1698/jquery.patch/index.html">jquery.patch</a> (1.4 KB) - added by diz
        <strong>September 20, 2007 03:51PM UTC</strong>.<br>
        <p>Patch</p>
      </li>
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (12)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed September 21, 2007 01:41PM UTC by <span class="author">c_t</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Thanks Gabriel for that patch! I was having the same problem you described and your patch fixed it for me! I hope it gets integrated to the jquery-source soon since this issue probably brakes a lot of ajax-applications!</p><p>Cheers, Christoph</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed September 25, 2007 08:33AM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>A reduced test case has been submitted by Carlos in this ticket:</p><p><a href="http://dev.jquery.com/ticket/1725" class="ext-link"><span class="icon"></span>http://dev.jquery.com/ticket/1725</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed September 25, 2007 08:40AM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>This ticket probably also describes the same bug: <a href="http://dev.jquery.com/ticket/1654" class="ext-link"><span class="icon"></span>http://dev.jquery.com/ticket/1654</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed September 27, 2007 12:51PM UTC by <span class="author">kennydee</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Hi, Thanks for your patch witch correct this issue but it create one another bug :</p><p>If we load $('#mydiv').load('test.html')</p><p>And test.html contains something like this : </p><p>&lt;script src='file1.js' type='text/javascript'&gt;&lt;/script&gt;</p><p>&lt;script src='file2.js' type='text/javascript'&gt;&lt;/script&gt;</p><p>It seems like file1 and file2 are loaded twice !</p><p>One with a timestamp, one without,</p><p>In firebug you will see something like this in "script" part :</p><p>file1.js</p><p>file1.js?_=1154545454545</p><p>file2.js</p><p>file2.js?_=1154545454599</p><p>If you know how to correct this issue ! :)</p><p>Hope this will integrated into a new jquery release soon !</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 01, 2007 07:02PM UTC by <span class="author">rrjanbiah</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Are you sure that it will work for external sourced scripts like Google <a href="/wiki/AdSense">AdSense</a>?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 12, 2007 03:43PM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Ok kennydee, I corrected the script to behave correctly for your test case.</p><p>I have also integrated the extractScript and evalScript function to jQuery and made them a bit easier to use.</p><p>Here is the modified jQuery code, again from line 385:</p><pre class="wiki">
	domManip: function(args, table, dir, fn) {
		var clone = this.length &gt; 1, a; 

		return this.each(function(){
			if ( !a ) {
				a = jQuery.clean(args, this.ownerDocument);
				if ( dir &lt; 0 )
					a.reverse();
			}

			var obj = this;

			if ( table && jQuery.nodeName(this, "table") && jQuery.nodeName(a[0], "tr") )
				obj = this.getElementsByTagName("tbody")[0] || this.appendChild(document.createElement("tbody"));

			jQuery.each(a, function() {
				var elem = clone ? jQuery.extractScript(this.cloneNode(true)) : jQuery.extractScript(this);
				if (elem[1])
					fn.call(obj, elem[1]);
				if (elem[0])
					jQuery.evalScript(elem[0]);
			});
		});
	}
};

// This function should be called with a single argument: the DOM elements in jQuery format.
// Returns an array containing at key 0 the extracted script elements and at key 1 the remaining DOM elements.
jQuery.extractScript = function() {
	var r = !arguments[1],
		elem = r ? arguments[0] : arguments[1];
	if ( jQuery.nodeName(elem, "script") ) {
		if ( elem.parentNode )
			elem.parentNode.removeChild(elem);
		if ( r )
			return [elem, null];
	} else if ( elem.nodeType == 1 )
		return [jQuery("script", elem).each(jQuery.extractScript), elem];
	else
		return [null, elem];
};

// This function should be called with a single argument: the script element alone or in a jQuery list.
jQuery.evalScript = function() {
	var scr = arguments[1] ? arguments[1] : arguments[0];
	if ( scr.each ) {
	    scr.each(jQuery.evalScript);
	} else {
		if ( scr.src )
			jQuery.ajax({ url: scr.src, async: false, dataType: "script" });
		else
			jQuery.globalEval( scr.text || scr.textContent || scr.innerHTML || "" );
	}
};
</pre><p>Thanks for your feedback!</p><p>Gabriel</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2007 02:39PM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>And this ticket describes the same bug again, with a simple workaround using setTimeout:</p><p><a href="http://dev.jquery.com/ticket/1793" class="ext-link"><span class="icon"></span>http://dev.jquery.com/ticket/1793</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2007 05:45PM UTC by <span class="author">Jebber007</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Does anyone know if this solution will be integrated into the next release?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:9">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 16, 2007 08:24AM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:9">comment:9</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I've no idea, Jebber007. I'm asking myself the same question!</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:10">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 16, 2007 06:08PM UTC by <span class="author">Jebber007</span></span>
        <a class="ticket-change-link" href="#comment:10">comment:10</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Great solution, diz. Works like a champ. It's better than mine, because mine doesn't evaluate inline functions correctly. Hope the developers see this an implement it!</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:11">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 17, 2007 10:44PM UTC by <span class="author">john</span></span>
        <a class="ticket-change-link" href="#comment:11">comment:11</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ fixed</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Fixed in SVN rev [3667]. I re-worked the evaluation order, pushing inline scripts onto a stack to be executed upon completion (except for scripts that are inline, before DOM elements - those are executed immediately). See the test case for an example.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:12">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 19, 2007 09:01PM UTC by <span class="author">diz</span></span>
        <a class="ticket-change-link" href="#comment:12">comment:12</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Very elegant, how you did that! I tested the nightly build and everything seems to work perfectly here.</p><p>Thanks a lot!</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

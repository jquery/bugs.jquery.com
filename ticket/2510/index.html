<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#2510 (Optimizations for the merge() method) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/2509/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/2511/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#2510</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">enhancement</span>
      <span class="ticket-resolution">(fixed)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened March 14, 2008 12:00PM UTC</p>
      
        <p>Closed May 13, 2008 02:21AM UTC</p>
      
      
    </div>
  </div>

  <h1 class="ticket-title">Optimizations for the merge() method</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        diego
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        major
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/1.2.4">1.2.4</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>core</td>
      
        <th>Version:</th>
      
      <td>1.2.3</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>By using the Firebug profiler I realized that the "merge()" function is one of the most often called function during element selection or matching and is the second most consuming function in a slickspeed run (7880 calls 27.6% time jquery 1.2.3.js, linux FF 2.0.12).</p><p>These are the reasons for which I thought this method may be improved:</p><ul><li>IE is checked for each call, even if we are using other browsers</li><li>the loop is looking up the same array twice instead of just once</li><li>there is a written (only) duplication of the for loop</li></ul><p>Take the last less seriously...but only one executes and cross browser debugging requires two hand written break-points...ha.ha.ha...</p><p>Probably this has been exacerbated by my last works ;-)</p><p>However even if it looks ugly what it does is simple, a function for each browser is compiled runtime when the absolute first call hit the function, and this is also the most compact way of writing it, well after removing the unnecessary concatenation fat.</p><pre class="wiki">
    merge: function( first, second ) {
        // We have to loop this way because IE & Opera overwrite the length
        // expando of getElementsByTagName

        // Also, we need to make sure that the correct elements are being returned
        // (IE returns comment nodes in a '*' query)
        this.merge = new Function('first, second',
                'var a, i = -1;'+
                'while (a = second[++i])'+
                    (jQuery.browser.msie ? 'if ( a.nodeType != 8 )' : '')+
                    'first[first.length] = a;'+
                'return first;'
        );
        return this.merge( first, second );
    },

</pre><p>on the thread we can probably look at less eye intrusive version.</p><p>Please tell if I should build/attach a real diff once this has been reviewed.</p><p>One catch is that after this, merge() shows up as an anonymous function, don't know if jQuery use some trick on fn names,</p><p>however it worked and now slickspeed numbers are different and looking at the profiler again have...7880 calls 17.8% time.</p><p>Well surely need review...gain start to be suspiciously high...</p><p>did I miss the obvious ?</p><p>Diego Perini</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (1)</summary>

  <ul class="ticket-attachments">
    
      <li>
        <a href="/attachment/ticket/2510/core-merge.patch/index.html">core-merge.patch</a> (0.9 KB) - added by diego
        <strong>March 29, 2008 10:56PM UTC</strong>.<br>
        
      </li>
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (6)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 29, 2008 10:55PM UTC by <span class="author">diego</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>After pondering and reviewing all the talks held on the "Performance Tweaks" thread, I rewrote the patch to the "merge()" method by using lazy functions. The real gain is obtained by doing the browser check only once instead of every time.</p><p>By not using the "new Function" constructor, as John suggested, the code will remain compatible with AIR. This method is called thousand of times in intensive selector queries so I tuned a bit the loop trying to avoid to lookup in the same array several times.</p><p>For IE I left the check on nodeType != 8 instead of nodeType == 1 as was suggested by me and Matt Kruse because this part is not really related to the "Performance Tweaks" we were talking.</p><p>Diego Perini</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 30, 2008 11:24AM UTC by <span class="author">rformato</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>At the very beginning of the merge function I read this comment:</p><pre class="wiki">
// We have to loop this way because IE & Opera overwrite the length
// expando of getElementsByTagName

</pre><p>Maybe that's the reason to stay with push to add elements to the array and not to use first.length, even if it is not the best choice about performance</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 30, 2008 08:14PM UTC by <span class="author">mkruse</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I would still like to recommend this change instead:</p><pre class="wiki">
jQuery.merge = function (first,second) { 
  var d; 
  if (document.createElement && document.createComment) { 
    d = document.createElement('div'); 
    d.appendChild(document.createComment("test")); 
    if (d.getElementsByTagName && d.getElementsByTagName('*').length&gt;0) { 
      return (newMerge3=function(first,second) { 
        var i=0,e; 
        while(e=second[i++]) 
          if (e.nodeType!=8) 
            first[first.length]=e; 
        return first; 
      })(first,second); 
    } 
  } 
  return (newMerge3=function(first,second) { 
    var i=0,e; 
    while(e=second[i++]) 
      first[first.length]=e; 
    return first; 
  })(first,second); 
}
</pre><p>It has the advantage of being a speedup and also avoiding the unnecessary browser sniff.</p><p>See <a href="http://groups.google.com/group/jquery-dev/browse_frm/thread/5019fa537c8d3595/3fb717b0dc43e4f0" class="ext-link"><span class="icon"></span>http://groups.google.com/group/jquery-dev/browse_frm/thread/5019fa537c8d3595/3fb717b0dc43e4f0</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 30, 2008 08:15PM UTC by <span class="author">mkruse</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Sorry, I had left the "newMerge3" reference inside the code...</p><pre class="wiki">
jQuery.merge = function (first,second) {
  var d;
  if (document.createElement && document.createComment) {
    d = document.createElement('div');
    d.appendChild(document.createComment("test"));
    if (d.getElementsByTagName && d.getElementsByTagName('*').length&gt;0) {
      return (jQuery.merge=function(first,second) {
        var i=0,e;
        while(e=second[i++])
          if (e.nodeType!=8)
            first[first.length]=e;
        return first;
      })(first,second);
    }
  }
  return (jQuery.merge=function(first,second) {
    var i=0,e;
    while(e=second[i++])
      first[first.length]=e;
    return first;
  })(first,second);
}
</pre>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 31, 2008 01:21PM UTC by <span class="author">rformato</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:2 rformato]:</p><blockquote> At the very beginning of the merge function I read this comment:   <pre class="wiki">
&gt; // We have to loop this way because IE & Opera overwrite the length
&gt; // expando of getElementsByTagName
&gt; 
&gt; </pre>  Maybe that's the reason to stay with push to add elements to the array and not to use first.length, even if it is not the best choice about performance </blockquote><p>After a search on svn I found [1594], so the comment was referring to the second array, not the first.</p><p>The patch is good.</p><p>Also consider storing first.length out of the loop in a local var and incrementing it on array augmentation:</p><pre class="wiki">
jQuery.merge = jQuery.browser.msie ?

             function( first, second ) {
                 var a, i = -1,fl = first.length;
                 while (a = second[++i])
                     if ( a.nodeType != 8 )
                         first[fl++] = a;
                 return first;
             } :
             function( first, second ) {
                 var a, i = -1,fl = first.length;
                 while (a = second[++i])
                     first[fl++] = a;
                 return first;
             };
return jQuery.merge( first, second ); 


</pre><p>This will speedup merge of another 5% in IE, much less in other browsers but it won't harm in any case</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed May 13, 2008 02:21AM UTC by <span class="author">flesler</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ fixed</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Added the looping optimizations at [5578], the code bifurcation will need to be approved in a general way for the code.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

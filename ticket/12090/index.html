<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#12090 (`jQuery.extend(deep, [])` causes infinite loop with self-referential attributes) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/12089/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/12091/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#12090</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(duplicate)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened July 16, 2012 08:55PM UTC</p>
      
        <p>Closed July 16, 2012 09:11PM UTC</p>
      
      
        <p>Last modified July 16, 2012 09:52PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">`jQuery.extend(deep, [])` causes infinite loop with self-referential attributes</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        lancejpollard@gmail.com
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        undecided
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/None">None</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>unfiled</td>
      
        <th>Version:</th>
      
      <td>1.7.2</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>I posted this as a pull request on <a href="/wiki/GitHub">GitHub</a> <a href="https://github.com/jquery/jquery/pull/863." class="ext-link"><span class="icon"></span>https://github.com/jquery/jquery/pull/863.</a> It usually creates an issue for it, didn't realize <a href="/wiki/GitHub">GitHub</a> issues were disabled for jQuery, so reposting here.</p><p>When jQuery tries to deep clone the object, it creates an infinite loop:</p><p><a href="https://github.com/jquery/jquery/blob/0d9006531d2b991cdbf419e1b4b0b4e03a588b10/src/core.js#L304" class="ext-link"><span class="icon"></span>jquery/src/core.js#L304</a></p><p>The important part is:</p><pre class="wiki">
for ( name in options ) {
  src = target[ name ];
  copy = options[ name ];
</pre><p>In Ember there is a setting to turn on accessors and to extend native objects. This creates a method on an array like <code>array['[]']</code>, which just returns itself (<code>this</code>):</p><p><a href="https://github.com/emberjs/ember.js/blob/3d8a3b301de8f602bf9842c15099d11307f35e96/packages/ember-runtime/lib/mixins/enumerable.js#L623" class="ext-link"><span class="icon"></span>ember-runtime/lib/mixins/enumerable.js#L623</a></p><p>I think there are two bugs here:</p><p>1. That part of <code>$.extend</code> should be using <code>hasOwnProperty</code>, but I'm not entirely sure about this. It returns false on accessors.</p><p>2. I've added <code>if (options === copy) continue</code>, which wasn't covered with just <code>if (target === copy) continue</code>, which is the problem with a property pointing to itself.</p><p>Here is where I ran into the error in some code:</p><pre class="wiki">
[].hasOwnProperty('length') // true
[].hasOwnProperty('[]') // false
var array = []
array['[]'] === array // true
</pre><p>Would adding this fix it you think?</p><pre class="wiki">
for ( name in options ) {
  if (options.hasOwnProperty(name)) {
    src = target[ name ];
    copy = options[ name ];
  // ...
</pre><p>It looks like this is probably a jQuery bug but it's getting late so I can't quite tell.</p><p>Try running <code>$.extend(true, [])</code> in the web console with <code>Ember.USE_ACCESSORS = true</code>, and it should create an infinite loop.</p><p>''(came across this using the jquery-file-upload plugin with ember accessors, it doesn't work b/c the ajax call it's making passes the files array into the <code>$.extend</code> method <a href="https://github.com/blueimp/jQuery-File-Upload/blob/02efca019a3033c5320cbcc5f8bf01522de3c8b7/js/jquery.fileupload.js#L644" class="ext-link"><span class="icon"></span>right here</a>)''</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (8)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:04PM UTC by <span class="author">lancejpollard@gmail.com</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Here is a jsFiddle demonstrating: <a href="http://jsfiddle.net/viatropos/hxgEC/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/viatropos/hxgEC/</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:11PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ duplicate</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p><a href="http://docs.jquery.com/Won't_Fix#Object.prototype_Issues" class="ext-link"><span class="icon"></span>http://docs.jquery.com/Won't_Fix#Object.prototype_Issues</a></p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:11PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Duplicate of <a href="/ticket/2721">#2721</a>.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:20PM UTC by <span class="author">anonymous</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Hey, there are two issues here, see the jsFiddle: <a href="http://jsfiddle.net/viatropos/hxgEC/3/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/viatropos/hxgEC/3/</a></p><pre class="wiki">
// infinite loop
$('#one').click(function() {
  var array = [];
  // self referential attribute
  array.self = array;

  try {
    $.extend(true, array);
  } catch (error) {
    _log(error.toString());
    alert(error);
  }
});
</pre><p>That is an even more significant problem</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:32PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Saw this earlier but haven't had time to look at it in detail.</p><p>Is there a general way to fix the infinite loop though? The cycle could occur anywhere within the data structure, and it could traverse through several other objects that end up back at one already visited. You've picked an easy case.</p><p>The effect of <code>$.extend()</code>ing custom objects, or native objects with augmented properties, isn't something we've ever defined because its use case was for extending plain objects and arrays. </p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:39PM UTC by <span class="author">anonymous</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>You're right, the problem could get complicated. But, the part of the pull request adding <code>options === copy</code> solves it for the simple case: <a href="https://github.com/viatropos/jquery/commit/3e82e53137049908b8c461708e04bd4ceff48986#L0R314" class="ext-link"><span class="icon"></span>https://github.com/viatropos/jquery/commit/3e82e53137049908b8c461708e04bd4ceff48986#L0R314</a></p><p>By making that change, I was able to use accessors, which happened to use self referential attributes, in the jQuery-File-Upload plugin, which passes the <code>FileList</code> array as a value in the options hash to <code>$.ajax</code>. By using the Ember.USE_ACCESSORS, that messes with the for loop like you guys pointed to in the "Won't Fix" bugs, but the real problem was that the accessor just caused a self referential attribute to become "visible" so to speak. So, solving this simple case would be very helpful.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:47PM UTC by <span class="author">gibson042</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:5 dmethvin]:</p><blockquote> Is there a general way to fix the infinite loop though? The cycle could occur anywhere within the data structure, and it could traverse through several other objects that end up back at one already visited. You've picked an easy case.</blockquote><p>There is a <a href="https://github.com/gibson042/jquery/commit/21b51e73568b5d7414489d606f18c3c0a54dc8b9#L0R818" class="ext-link"><span class="icon"></span>general way</a>, but it's historically been deemed too heavy (both in code size and performance) for us to implement.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 16, 2012 09:52PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>@gibson042, true, I had ignored that as a solution given its cost, and since most uses don't encounter it I think we should continue to ignore it. :-)</p><p>As for this specific case it's a bit cheaper to implement since it doesn't require a list.</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#11150 ($.map inconsistent behavior) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/11149/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/11151/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#11150</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(invalid)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened January 10, 2012 03:19PM UTC</p>
      
        <p>Closed January 10, 2012 08:42PM UTC</p>
      
      
        <p>Last modified January 10, 2012 09:05PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">$.map inconsistent behavior</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        davestein
      </td>
      <th>Owned by:</th>
      <td>davestein</td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        undecided
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/None">None</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>unfiled</td>
      
        <th>Version:</th>
      
      <td>1.7.1</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th>Cc:</th>
      
      <td>danheberden</td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>I came across an issue where IE8 will iterate through an object too many times. If an object has 3 items and we use $.map on it, and alter the indexes during the loop for all 3 items, it will loop 6 times. The fiddle shows what I mean since it's pretty hard for me to explain.</p><p><a href="http://jsfiddle.net/davestein/xKzyV/9/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/davestein/xKzyV/9/</a></p><p>Anyway I'm aware it's an IE8 bug. The strange thing is it seems as though $.map attempts to work around it. If I do $.map in IE9 or IE9's IE8 mode it works fine. If I do $.map in IE8 it does not work.</p><p>I'm aware that IE8 mode is not identical to IE8. So as a constant I used native JS and it broke in all cases. If jQuery wasn't trying to account for it, I'm unsure why $.map would work on IE8 mode, but not IE8.</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (14)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 03:28PM UTC by <span class="author">davestein</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Oh as I note my workaround is:</p><p>var x = { a_1 : 1 };</p><p>var copy = $.extend( {}, x );</p><p>$.map( copy, function( value, key ) {</p><p>  var new_key = key.replace( 'a_', '' );</p><p>  x[new_key] = value;</p><p>  delete( x[key] );</p><p>});</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 04:45PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>owner:</th>
                  <td>
                    
                      <span class="change-field-new">→ davestein</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">pending</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Can you reduce that fiddle to something a little simpler?</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 05:14PM UTC by <span class="author">Dave Stein &lt;dave@behance.com&gt;</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I went to make it simpler and then found another interesting point of confusion.</p><p><a href="http://jsfiddle.net/davestein/xKzyV/16/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/davestein/xKzyV/16/</a>  </p><p>Yields bad results every time, no matter what browser/mode/function.</p><p><a href="http://jsfiddle.net/davestein/xKzyV/9/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/davestein/xKzyV/9/</a>  </p><p>Does not yield bad results for $.map in IE8 mode as I had previously reported.</p><p>Expected Results:</p><p>a_1 1, a_2 2, a_3 3</p><p>Bad results:</p><p>a_1 1, a_2 2, a_3 3, 1 1, 2 2, 3 3</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 06:34PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I'm not sure this is something jQuery can fix:</p><p><a href="http://gyazo.com/bd96a4c4d1ec26f0863e9eede7b755dc.png" class="ext-link"><span class="icon"></span>http://gyazo.com/bd96a4c4d1ec26f0863e9eede7b755dc.png</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:07PM UTC by <span class="author">Dave Stein &lt;dave@behance.com&gt;</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Any idea why it works fine in fiddle version 9, in IE8 mode? That's the part that confuses me most. I'd expect it to duplicate in all situations.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:10PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
                <tr>
                  <th>cc:</th>
                  <td>
                    
                      <span class="change-field-new">→ danheberden</span>
                    
                  </td>
                </tr>
              
            
              
            
          </tbody>
        </table>
        
          
        
          
            <div class="ticket-comment-body">
              <p>I'm not sure, I'll have danheberden take a look - he most recently authored changes to $.map, so he may have insight that I don't immediately see</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:17PM UTC by <span class="author">danheberden</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p><a href="/wiki/DaveMethvin">DaveMethvin</a> was in there recently too. I don't recall any issues with IE8 that I ran into via tests 'n stuff. The disparity between IE8 and IE8 mode seems sensible, sense they aren't the same version. </p><p>Yay bugs!</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:22PM UTC by <span class="author">Dave Stein &lt;dave@behance.com&gt;</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I'm wondering if map can fix the issue the way I did myself. If it iterates on a copy instead of actual object, and the callback just returns arguments of value and index, I don't see how that would break existing code.</p><p>It also seems "this" inside callback refers to window instead of object so that's one less thing to worry about for such a change.</p><p>Dan, the disparity is def sensible, if it was at least consistent between my fiddles :) Maybe I'm missing a minute detail of difference between the two because I'm using functions in one and not the other. I can't think of why that would change the outcome.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:9">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:31PM UTC by <span class="author">danheberden</span></span>
        <a class="ticket-change-link" href="#comment:9">comment:9</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>The biggest thing I see as a problem is the cost of copying first - &lt;IE8 is already awfully slow with map, and a copy would just be that much more work (thinking where $.map is used internally as an immediate pain point). </p><p>Sounds like the first step would be testing for when this happens?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:10">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:37PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:10">comment:10</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Something to note... $.map is being used here for "side effects" which is technically an incorrect use. $.map is expected to return an array, if you want to iterate values and do something with them that will produce side effects, then use $.each. </p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:11">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:41PM UTC by <span class="author">danheberden</span></span>
        <a class="ticket-change-link" href="#comment:11">comment:11</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Additionally, the bug in question seems to be directly related to deleting keys on an object in IE8, not map's function of iterating.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:12">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:42PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:12">comment:12</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
                <tr>
                  <th>_comment0:</th>
                  <td>
                    
                      <span class="change-field-old">To follow up on rwaldron&#39;s comment, would you say it&#39;s safe practice to modify the incoming object while you&#39;re iterating it? In every language I&#39;ve used, modifying a collection in the midst of iteration is, at minimum, a point of concern. It is for the very reason that you see here.&#92;
&#92;
For example, C++ STL iterators don&#39;t support modifying the collection while it&#39;s being iterated. Microsoft Win32 API filesystem calls like FindNextFile behave inconsistently when you add or remove files from the current directory while iterating it. The same goes for Java&#39;s Iterator, where items can only be deleted (no additions) during iteration. &#92;
&#92;
Sure enough, ECMA-262, section 12.6.4 says:&#92;
&#92;
&gt; The mechanics and order of enumerating the properties (step 6.a in the first algorithm, step 7.a in the second) is not specified. Properties of the object being enumerated may be deleted during enumeration. If a property &#92;
that has not yet been visited during enumeration is deleted, then it will not be visited. If new properties are added to the object being enumerated during enumeration, the newly added properties are not guaranteed to be visited in the active enumeration. A property name must not be visited more than once in any enumeration.&#92;
&#92;
One way to get a consistent set of results is to obtain the list of keys in advance, before starting the iteration. But that&#39;s expensive and potentially wasteful so many iteration classes/implementations try to avoid it.&#92;
&#92;
It&#39;s easy to create a new object rather than trying to mess with the current one while it&#39;s being iterated. That is actually the semantics of a .map() operator, since it came from functional programming where you would be shot, then drawn and quartered, for mutating an incoming object! &#92;
&#92;
Since this is an edge case and documented to have undefined behavior, if you absolutely must modify the current object then write code that gets the keys in advance.&#92;
</span> → <span class="change-field-new">1326228161973672</span>
                    
                  </td>
                </tr>
              
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ invalid</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">pending</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
        
          
            <div class="ticket-comment-body">
              <p>To follow up on rwaldron's comment, would you say it's safe practice to modify the incoming object while you're iterating it? In every language I've used, modifying a collection in the midst of iteration is, at minimum, a point of concern. It is for the very reason that you see here.</p><p>For example, C++ STL iterators don't support modifying the collection while it's being iterated. Microsoft Win32 API filesystem calls like <a href="/wiki/FindNextFile">FindNextFile</a> behave inconsistently when you add or remove files from the current directory while iterating it. The same goes for Java's Iterator, where items can only be deleted (no additions) during iteration. </p><p>Sure enough, ECMA-262, section 12.6.4 says:</p><blockquote> The mechanics and order of enumerating the properties (step 6.a in the first algorithm, step 7.a in the second) is not specified. Properties of the object being enumerated may be deleted during enumeration. If a property that has not yet been visited during enumeration is deleted, then it will not be visited. If new properties are added to the object being enumerated during enumeration, the newly added properties are not guaranteed to be visited in the active enumeration. A property name must not be visited more than once in any enumeration.</blockquote><p>One way to get a consistent set of results is to obtain the list of keys in advance, before starting the iteration. But that's expensive and potentially wasteful so many iteration classes/implementations try to avoid it.</p><p>It's easy to create a new object rather than trying to mess with the current one while it's being iterated. That is actually the semantics of a .map() operator, since it came from functional programming where you would be shot, then drawn and quartered, for mutating an incoming object! </p><p>Since this is an edge case and documented to have undefined behavior, if you absolutely must modify the current object then write code that gets the keys in advance.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:13">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 08:52PM UTC by <span class="author">Dave Stein &lt;dave@behance.com&gt;</span></span>
        <a class="ticket-change-link" href="#comment:13">comment:13</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Thanks for the detailed answer Dave. I'm going to stick with getting keys in advance then. I still have to wonder why I got different results between the two fiddles though.</p><p>And to your point rwaldron, I'm going to have our code changed from $.map to $.each. I almost never use $.map, didn't click in my head to have coworker switch his $.map to $.each because of side effect.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:14">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 10, 2012 09:05PM UTC by <span class="author">rwaldron</span></span>
        <a class="ticket-change-link" href="#comment:14">comment:14</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Glad to have been a help - thanks again for the report.</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

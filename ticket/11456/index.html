<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#11456 (.html(htmlString) fails in IE when 1st char is space and a close div tag exists in the string) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/11455/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/11457/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#11456</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(wontfix)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened March 08, 2012 10:32PM UTC</p>
      
        <p>Closed March 11, 2012 12:35PM UTC</p>
      
      
        <p>Last modified April 13, 2012 06:25PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">.html(htmlString) fails in IE when 1st char is space and a close div tag exists in the string</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        phairow
      </td>
      <th>Owned by:</th>
      <td>phairow</td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        low
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/None">None</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>misc</td>
      
        <th>Version:</th>
      
      <td>1.7.1</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>when using .html(htmlString), the innerHTML of the specified element will be set to empty string when the htmlString passed starts with a space and contains a dangling end div tag.</p><p>EX: jQuery("#content").html(" Hello&lt;/div&gt;");</p><p>Here is the jsFiddle: <a href="http://jsfiddle.net/Wj2cQ/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/Wj2cQ/</a></p><p>Tested in IE8 with all versions of jQuery that are available through jsFiddle. This does not repro in any other browser that I tested which include current versions of Chrome, Firefox, Opera, Safari on both pc and mac.</p><p>It fails any time the string starts with a space and contains a dangling &lt;/div&gt; anywhere in the string.</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (8)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 09, 2012 12:51AM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>owner:</th>
                  <td>
                    
                      <span class="change-field-new">→ phairow</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">pending</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>It doesn't look like it failed to me. It was fed invalid HTML which has undefined results. Although HTML5 has defined the parsing rules strictly, IE8 predates that. </p><p>Is there some way jQuery is supposed to fix this? We're not about to start <code>RegExp</code>ing strings to fix invalid HTML.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 09, 2012 08:55PM UTC by <span class="author">phairow</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">pending</span> → <span class="change-field-new">new</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:1 dmethvin]:</p><blockquote> It doesn't look like it failed to me. It was fed invalid HTML which has undefined results. Although HTML5 has defined the parsing rules strictly, IE8 predates that.   Is there some way jQuery is supposed to fix this? We're not about to start <code>RegExp</code>ing strings to fix invalid HTML.</blockquote><p>The problem is that jQuery is attempting to provide a cross-browser abstraction which in this case behaves differently in different browsers. If I set the innerHTML directly on the dom element then this bug does not occur.  It is specific to the way jQuery is adding the string to the dom that is not compatible with IE for this scenario. Here is an updated jsFiddle to illustrate the point: <a href="http://jsfiddle.net/Wj2cQ/1/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/Wj2cQ/1/</a></p>
            </div>
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 11, 2012 12:35PM UTC by <span class="author">addyosmani</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>component:</th>
                  <td>
                    
                      <span class="change-field-old">unfiled</span> → <span class="change-field-new">misc</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>priority:</th>
                  <td>
                    
                      <span class="change-field-old">undecided</span> → <span class="change-field-new">low</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ wontfix</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>My two cents on this are: garbage in, garbage out. As dmethvin has pointed out, it really doesn't make sense to start adding additional regex. (which would likely come with a performance cost) just to cover the case of someone inputting invalid HTML (and for just one browser). If a user absolutely needs to be covering the case of such input being used, you could simply write a plugin that does use innerHTML directly on the DOM element for their use case.</p>
            </div>
          
        
          
        
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 11, 2012 09:32PM UTC by <span class="author">phairow</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:3 addyosmani]:</p><blockquote> My two cents on this are: garbage in, garbage out. As dmethvin has pointed out, it really doesn't make sense to start adding additional regex. (which would likely come with a performance cost) just to cover the case of someone inputting invalid HTML (and for just one browser). If a user absolutely needs to be covering the case of such input being used, you could simply write a plugin that does use innerHTML directly on the DOM element for their use case.</blockquote><p>I understand your reasoning and I do agree that it is garbage. I don't want to cause you to add a regex that is only for this obscure case. I am simply dismayed at the outcome of this since setting innerHTML works and using jQuery .html(htmlString) does not. I am building a content publishing system. The system combines templates which are created by template developers and designers with content created by content editors. Since I have seen their existing system and it contains malformed templates I must ensure the consistency of my system by putting any string however malformed that they give me into the output page. In addition to that some of the content is also html and could be malformed. Since I am simply providing a way for the different teams to render their content and if their templates and content render in their stand-alone browser tests then it must also work when the content and templates are uploaded into my system for rendering. I will continue to use the innerHTML directly and hopefully future versions of IE will not contain this bug. If you know why it is happening then perhaps we can file a bug with the IE team.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed March 12, 2012 09:08PM UTC by <span class="author">phairow</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I have looked into this further and I have found the cause. It is the result of another IE workaround that is causing this issue.</p><p>Around line 1347 is this setting:</p><pre class="wiki">
// Make sure that link elements get serialized correctly by innerHTML
// This requires a wrapper element in IE
htmlSerialize: !!div.getElementsByTagName("link").length
</pre><p>Around line 5673 is this check which adds the workaround wrapper text:</p><pre class="wiki">
// IE can't serialize &lt;link&gt; and &lt;script&gt; tags normally
if ( !jQuery.support.htmlSerialize ) {
    wrapMap._default = [ 1, "div&lt;div&gt;", "&lt;/div&gt;" ];
}
</pre><p>Around line 6287 we take the workaround wrapper text:</p><pre class="wiki">
wrap = wrapMap[ tag ] || wrapMap._default,
</pre><p>Next around line 6301 we wrap the html content and insert it into the dom:</p><pre class="wiki">
// Go to html and back, then peel off extra wrappers
div.innerHTML = wrap[1] + elem + wrap[2];
</pre><p>Finally we remove the wrapper:</p><pre class="wiki">
// Move to the right depth
while ( depth-- ) {
    div = div.lastChild;
}
</pre><p>While the existing .html(htmlString) workaround may fix a problem with how link and script tags are inserted into the dom in IE, it introduces the problem with rogue div tags in IE.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 13, 2012 04:22PM UTC by <span class="author">cmcnulty</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>phairow, you're exactly correct about the workaround, and the problems it causes with invalid html.  And actually, a "fix" that you could apply would be pretty simple.  You could use the existing regex tests rnoInnerHtml and rnoshimcache as tests and only apply the wrapper fix if there's a match.  *However* that's going to cause other potential issues.  This bug exists in IE &lt;=8 for *all* unknown html elements.  So, while only applying the wrapper fix for rnoInnerHtml and rnoshimcache will fix the "NoScope" bug for the majority of cases, IE will still fail on using</p><pre class="wiki">
$(foo).html("&lt;bar&gt;&lt;/bar&gt;");
</pre><p>Basically the choice is to have the wrapMap._default apply selectively and break IE for unknown elements that aren't in those lists, or apply wrapMap._default on all snippets and have it return unpredicted results when inserting borked html.</p><p>By the way, for a full understanding of what the code you highlighted is attempting to fix, I highly recommend <a href="http://social.msdn.microsoft.com/forums/en-US/iewebdevelopment/thread/33fd33f7-e857-4f6f-978e-fd486eba7174/" class="ext-link"><span class="icon"></span>this thread</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 13, 2012 04:27PM UTC by <span class="author">cmcnulty</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Duplicate of <a href="/ticket/5353">#5353</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 13, 2012 06:25PM UTC by <span class="author">anonymous</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Thanks cmcnulty, I really appreciate the follow up and I understand that it the goal of jQuery to behave consistently across browsers especially IE is very difficult to accomplish. </p><p>I checked out the link and it does a good job of explaining the need for the workaround with style tags. I also agree based on your explanation that the fix for my issue would cause other inconsistencies. I hope that eventually a fix can be found since it is a difficult issue to detect and in my case the solution was to not use jQuery html() for the rendering portion of the cms. </p><p>Do you think it would make sense to update the documentation to warn about malformed or invalid html?</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

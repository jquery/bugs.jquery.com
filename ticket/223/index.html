<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#223 (IE6 jQuery.ready bug in jQuery Rev. 249 (released 8/31/06)) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/222/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/225/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#223</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(worksforme)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened September 28, 2006 02:57PM UTC</p>
      
        <p>Closed November 11, 2006 11:32AM UTC</p>
      
      
        <p>Last modified March 15, 2012 10:18AM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">IE6 jQuery.ready bug in jQuery Rev. 249 (released 8/31/06)</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        Josh
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        major
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/1.0">1.0</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>core</td>
      
        <th>Version:</th>
      
      <td>1.0</td>
    </tr>
    <tr>
      
        <th>Keywords:</th>
      
      <td>IE6 ready hack</td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>IE6 (unreliably) generates the following error message at line 1200 of the latest unpacked version of jQuery:</p><p>'null' is null or not an object</p><p>See line 1200:</p><p>script.onreadystatechange = function() {</p><p>	if ( this.readyState != "complete" ) return;</p><p>	this.parentNode.removeChild( this );</p><p>	jQuery.ready();</p><p>};</p><p>The error results from a failure on the previous line:</p><p>var script = document.getElementById("__ie_init");</p><p>This leaves the script variable as null. I was able to eliminate the error with the following:</p><p>if (script != null) {</p><p>	script.onreadystatechange = function() {</p><p>		if ( this.readyState != "complete" ) return;</p><p>		this.parentNode.removeChild( this );</p><p>		jQuery.ready();</p><p>	};</p><p>}</p><p>Unfortunately this means the script has to fallback on the window.onload event, which is obviously undesirable on slow-loading pages. The flaw seems to be in Matthias Miller's hack. There is also a discussion on the hack itself and the need for it, as referenced in the jQuery source code:</p><p><a href="http://www.outofhanwell.com/blog/index.php?title=the_window_onload_problem_revisited" class="ext-link"><span class="icon"></span>http://www.outofhanwell.com/blog/index.php?title=the_window_onload_problem_revisited</a></p><p>Obviously this hack is not ideal since it uses the deprecated document.write method, but then, neither is IE.</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (6)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed September 28, 2006 03:02PM UTC by <span class="author">Josh</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I should add in case it's not obvious from the js code... The function will only have to fallback on window.onload on the occasion where it would have otherwise failed and given the ['null' is null or not an object] error.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 08, 2006 02:27AM UTC by <span class="author">brandon</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I haven't been able to reproduce this.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 16, 2006 11:26PM UTC by <span class="author">richard.chri</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>The bug is worse than that.</p><p>JQuery has a very nasty concurrency issue with IE which (bless its 100% polyester Micro$oft $ock$) actually uses real execution threads when handling events. This is almost certainly the case with other broswers too, but I was unable to reproduce this - possibly due to differing threading models.</p><p>There is a very nasty concurrency issue which I discovered when experimenting with thickbox </p><p>namely, when thickbox does</p><p><code>$(document).ready(TB_init);</code></p><p>something else may be calling Ready() at the same time resulting in the function (in this case <code>TB_init</code> getting pushed onto a queue that never gets pop'd again.</p><p>Sadly Javascript being a totally brokenn language has very little support for thread identifications (what's a thread anyway?) - no way of getting thread id's. No sleep function. No mutexes.</p><p>I was half way through trying to implement some hack for this when I thought about googling... Fortunately, I came across some rather nice code for implementing a busy-wait polling mechanism for mutual exclusion on the web. Obviously without 'sleep' there's no other way to do it.</p><p>original code and article can be found at:</p><p><a href="http://www.developer.com/lang/jscript/article.php/3592016" class="ext-link"><span class="icon"></span>http://www.developer.com/lang/jscript/article.php/3592016</a></p><p>I hacked this up so as to do the following:</p><p>added mutex code:</p><pre class="wiki">
// Mutex stuff...

var NEXT_CMD_ID = 0; 

function Map() { 
  this.map  = new Object(); 
  // Map API 
  this.add      = function(k,o){ this.map[k] = o;    } 
  this.remove   = function( k ){ delete this.map[k]; } 
  this.get      = function( k ){ return k==null ? null : this.map[k]; } 
  this.first    = function(   ){ return this.get( this.nextKey( ) ); } 
  this.next     = function( k ){ return this.get( this.nextKey(k) ); } 
  this.nextKey  = function( k ){
    for (i in this.map) {
      if (!k) return i; 
      if (k==i) k=null; /*tricky*/ 
    } 
    return null; 
  }
}

function Mutex( cmdObject ) { 
  // define static variable and method 
  if (!Mutex.Wait) Mutex.Wait = new Map(); 
  Mutex.SLICE = function( cmdID, startID ) { 
    Mutex.Wait.get(cmdID).attempt( Mutex.Wait.get(startID) ); 
  } 
  // define instance method 
  this.attempt = function( start ) { 
    for (var j=start; j; j=Mutex.Wait.next(j.c.id)) { 
      if (j.enter || (j.number && (j.number &lt; this.number || 
           (j.number == this.number && j.c.id &lt; this.c.id) ) ) ) 
       return setTimeout("Mutex.SLICE("+this.c.id+","+j.c.id+")",10); 
    } 
    this.c.go(); //run with exclusive access 
    this.number = 0;           //release exclusive access 
    Mutex.Wait.remove( this.c.id );
    return null;
  } 
  // constructor logic 
  this.c        = cmdObject; 
  Mutex.Wait.add( this.c.id, this ); //enter and number are Â“falseÂ” 
  this.enter    = true; 
  this.number   = (new Date()).getTime(); 
  this.enter    = false; 
  this.attempt( Mutex.Wait.first() ); 
} 

function MutexCommand( f, args ){ 
        this.id = ++NEXT_CMD_ID;
        this.result = null;
        this.go = function(){
                try { f( args ); }
                catch ( e ) { alert( e.message() ); }
        } 
}

</pre><p>then changed the <code>ready(f)</code> functions to the following - it could be done more neatly, but this was just an example (similar changes were made to wrap the ready() function:</p><pre class="wiki">
ready: function(f) {
    //alert( "creating 1" );
    var foo = function(args) {
     //   alert( "callback 1 fired" );
        var jq = args.jq;
        var pass_func = args.f;
        // If the DOM is already ready
        if ( jq.isReady ) {
            // Execute the function immediately
            f.apply( document );
        }
        // Otherwise, remember the function for later
        else {
            // Add the function to the wait list
            jq.readyList.push( pass_func );
        }
    }
    var args = new Object();
    args.f = f;
    args.jq = jQuery;
    //alert( "passing 1" );
    new Mutex(new MutexCommand( foo, args ) );
    return this;

}
</pre><p>Finally, the <code>document.write</code> hack is bad (tm). Sure it's cute in a nasty sort of way, and kudos to the original author. (IE's utter uselessness drives me up the wall so often I would love to blow redmond up, and half the users of the internet for using it ;) but I digress... )  However, it really doesn't work nicely if jquery.js is itself dynamically written to the DOM or even (again) with concurrency issues. Much better (IMHO) is to use the same timer type hack as for safari (and fall back on the onload method). Certainly with IE 6, this works fine.</p><p>The other thing to watch out for though is that (at least on IE 6 and with dynamic inclusion), IE will give back a readyState of "loaded" rather than complete. Thus the original code for IE's hack becomes more simply (if not more nicely) :</p><pre class="wiki">
    } else if ( jQuery.browser.msie ) {        
        var func = function() {
                if ( document.readyState == "complete" || document.readyState == "loaded" ) {
                    jQuery.ready();
                } else {
                    window.setTimeout = setInterval( func, 200 );
                }
            };
        window.setTimeout( func, 200 );
</pre><p>Again, this could be done better, but I've had issues with setInterval in IE before. Since I (i.e. clients) don't care about IE versions &lt; 6 nowadays, this suits me. :)</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 16, 2006 11:33PM UTC by <span class="author">richard.chri</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I should add that the "null" error the orginal bug was raised against is a symptom of the <code>document.write</code> hack not working. It can be easily reproduced in IE 6 by simply dynamically including <code>jquery.js</code> (say via a DOM write method after the page has already loaded, rather than by AJAX and eval) and watching IE barf with the mentioned error. The 'script' comes out null.</p><p>Incidentally, my patches were against 1.0.2 (svn rev 413) of the code. I also did some clean-up to remove the voluminous amount of warnings/fake-errors given by firefox's javascript console when running through the functions - but I don't think those affected any of the code snippets shown. Whilst they don't really matter, it would be nice if someone code run using firefox and just clean those up properly. :)</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 17, 2006 08:22PM UTC by <span class="author">Josh</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>To lend some weight to Richard's last statement, I definitely should have mentioned in my original bug report that I was dynamically adding jquery, and then subsequent javascript, to the DOM.</p><p>In addition to the small fix I mentioned, I have since decided that the added html simplicity is not worth the added bugs, and am migrating all of my javascript includes to the main html doc rather than doing it on the fly from a single global javascript.</p><p>Now to put my thinking cap on and re-read the longer post above with the javascript hacks...</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed November 11, 2006 11:32AM UTC by <span class="author">joern</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ worksforme</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Please correct me if I got it wrong, but to summarize this: If you include jQuery dynamically, you can't rely on jQuery DOM ready functionality. "Fixing" this causes way too much problems, therefore: If you really need the dynamic inclusion, find something else for the DOM ready event.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

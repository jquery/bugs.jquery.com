<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#12642 (jq improperly evaluates scripts inserted in dom fragments) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/12641/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/12643/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#12642</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(wontfix)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened October 03, 2012 02:01PM UTC</p>
      
        <p>Closed October 15, 2012 03:18PM UTC</p>
      
      
        <p>Last modified October 15, 2012 03:48PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">jq improperly evaluates scripts inserted in dom fragments</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        karger
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        undecided
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/None">None</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>manipulation</td>
      
        <th>Version:</th>
      
      <td>1.8.2</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>When jquery is used to insert scripts in the current document, they are evaluated as expected.  However, jquery also evaluates scripts that are inserted into dom fragments, e.g. $('&lt;head&gt;&lt;/head&gt;').append('my script').  This violates the notion of dom fragments as standing apart from the document.   In contrast, setting document.createElement().innerHTML does *not* lead to script evaluation.   I believe the primitive operations are more correct in this case.</p><p>I have posted demonstration code at <a href="http://people.csail.mit.edu/karger/Jquery/script-eval.html" class="ext-link"><span class="icon"></span>http://people.csail.mit.edu/karger/Jquery/script-eval.html</a></p><p>I have found superficially related bug <a href="http://bugs.jquery.com/ticket/11324" class="ext-link"><span class="icon"></span>http://bugs.jquery.com/ticket/11324</a> ; however, that bug seems to be about failing to clean scripts when they are inserted in the dom; not when they are in a dom fragment.  Also, unlike the claim in that bug, this is not a "contrived" scenario.  I need to parse some passed-in markup *without* executing any scripts I see, and appending that markup to a dom fragment seemed the obvious way.</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (15)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 02:11PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Hey karger, this sounds like a great use case for the new <code>$.parseHTML()</code> method that was introduced in 1.8. We're a bit behind in the docs for it, but it looks like <code>$.parseHTML(htmlString, context, runScripts)</code> where <code>context</code> is the document to be used, and <code>runScripts</code> is a Boolean indicating whether to evaluate script tags within the html. It returns an array of DOM elements which you can pass to <code>$()</code>. Does that work for you?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 02:13PM UTC by <span class="author">gibson042</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>component:</th>
                  <td>
                    
                      <span class="change-field-old">unfiled</span> → <span class="change-field-new">manipulation</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>This is a subset of <a href="/ticket/11795">#11795</a>, but might merit standalone discussion.</p>
            </div>
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 02:17PM UTC by <span class="author">anonymous</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Thanks for the quick response!  $.parseHTML is exactly what I need (assuming it works in all browsers including IE) and was trying to simulate on my own.  </p><p>Is there documentation anywhere?  What is the "context" argument in this case?  If I just want a dom fragment am I supposed to invoke $.parseHTML(string, false) and leave out the context parameter?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 02:21PM UTC by <span class="author">karger</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Clarification---that "anonymous" reply is from me using wrong browser.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 03:21PM UTC by <span class="author">karger</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>On a quick test, it appears that $.parseHTML is unable to parse &lt;html&gt;, &lt;head&gt;, or &lt;body&gt; tags.  This is unfortunate as one of the main reasons I am trying to parse is to properly separate the head from the body of the markup I receive.  </p><p>Is there a technical barrier to parsing these tags?  &lt;head&gt; and &lt;body&gt; are valid nodes in a dom fragment.  Even parsing the &lt;html&gt; tag seems technically feasible, as it should return a document (distinct from the "current" document).</p><p>Are these the only problematic tags, so that if I manually separate the head and body portions I can count on the rest being parsed correctly?  </p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 03:52PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>The typical way to parse HTML strings is to assign them to the <code>.innerHTML</code> property of a <code>div</code> element. Since there are several elements that cannot be valid children of a <code>div</code>, we create wrappers <a href="https://github.com/jquery/jquery/blob/1.8.2/src/manipulation.js#L31" class="ext-link"><span class="icon"></span>as best we can</a>. But in the case of something like a <code>body</code> or <code>head</code> you would need to start with a <code>html</code> element and even then I seem to recall oldIE won't do it. And if the string is a full HTML file starting with a doctype and <code>html</code> element, I am not sure we can parse it using <code>.innerHTML</code> at all, anywhere.</p><p>The only legitimate way to parse an entire document text that I know of is to parse it as XML, dealing with all the strict requirements that entails (e.g., no sloppy HTML5-ish parsing foregiveness). Then you could pull out the parts you need, convert them back to strings, and send them to <code>$.parseHTML</code> perhaps. You can't just import XML nodes into an HTML document, at least not in oldIE.</p><p>This issue might be addressable in some reasonable way in jQuery 2.0 using <code>createContextualFragment</code> perhaps, see <a href="/ticket/10426">#10426</a>.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 04:04PM UTC by <span class="author">ajpiano</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Related:</p><p><a href="http://bugs.jquery.com/ticket/7784" class="ext-link"><span class="icon"></span>http://bugs.jquery.com/ticket/7784</a></p><p><a href="http://benalman.com/projects/jquery-misc-plugins/#htmldoc" class="ext-link"><span class="icon"></span>http://benalman.com/projects/jquery-misc-plugins/#htmldoc</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 03, 2012 04:08PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Right, there's the illegitimate way using Regex, now you have two problems. :)</p><p>I just verified my recollection that it's not possible to use <code>.innerHTML</code> on an <code>html</code> element in oldIE, this throws an error "Could not set the innerHTML property. Invalid target element for this operation."</p><p><a href="http://jsfiddle.net/BnUGF/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/BnUGF/</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:9">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 04, 2012 05:34AM UTC by <span class="author">karger</span></span>
        <a class="ticket-change-link" href="#comment:9">comment:9</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Actually, the newer browsers are beginning to offer <a href="/wiki/DomParser">DomParser</a>.parseHTML() method that can take a whole document.  It's already available in ff and on the way in webkit; in the meantime you can parse a whole document by setting innerHTML on a new documentElement as is demonstrated <a href="https://developer.mozilla.org/en-US/docs/DOM/DOMParser" class="ext-link"><span class="icon"></span>here</a> in a js implementation of domParser.parseHTML in webkit.  </p><p>Unfortunately IE is behind usual.  I had hoped that you could generate a new head element and set innerHTML on that in order to parse a head's contents, but even that is forbidden by IE.  Have you considered using e.g. <a href="http://ejohn.org/blog/pure-javascript-html-parser/" class="ext-link"><span class="icon"></span>ejohn's pure js html parser</a> for that case, or does that bloat jquery too much?  You wouldn't need to use the ejohn's parser all the way down, but just use it to find the children of the head; each these could be parsed the usual way via innerHTML, and the results concatenated.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:10">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 04, 2012 02:18PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:10">comment:10</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>There is no way we'd include a JS-based HTML parser in jQuery for an edge case like this. If you just need something quick and dirty, the plugin from Ben Alman might do.</p><p>Would you be interested in putting together a plugin that incorporated the other methods to see if they can create a viable cross-browser solution? I'm not sure it's ready for jQuery core but it could be useful in its own right.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:11">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 07, 2012 02:48PM UTC by <span class="author">karger</span></span>
        <a class="ticket-change-link" href="#comment:11">comment:11</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>So I put together a library that combines the three methods (all implemented by other people).  The natural approach seemed to be extended the DOMParser object, to try first in native, then set an innerHTML, and finally to use ejohn's parser (in which I fixed a couple bugs).  </p><p>It wouldn't be hard to make this into a jQuery plugin, but should I?  Or is it more natural to work in the DOMParser namespace?</p><p>If I understand your comment <a href="/ticket/10">#10</a>, I could indeed incorporate the "other" methods (native domParser, plus setting innerHTML), but the result would not be cross-browser without a solution for IE.  Were you suggesting to not worry about IE?</p><p>It would seem to make sense for your $.parseHTML to invoke DOMParser on those platforms where it can...</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:12">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2012 03:18PM UTC by <span class="author">mikesherov</span></span>
        <a class="ticket-change-link" href="#comment:12">comment:12</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ wontfix</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:13">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2012 03:19PM UTC by <span class="author">timmywil</span></span>
        <a class="ticket-change-link" href="#comment:13">comment:13</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>We won't be doing this in core.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:14">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2012 03:36PM UTC by <span class="author">karger</span></span>
        <a class="ticket-change-link" href="#comment:14">comment:14</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I recognize not wanting to put a full-blown html parser in core.  However, this discussion wandered off the original issue, which is that it appears to be a bug that jquery is evaluating scripts inserted in dom fragments.  Is there a reason not to fix that bug, by the limited change of checking whether scripts are going into the (main) dom before evaluating them?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:15">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 15, 2012 03:48PM UTC by <span class="author">gibson042</span></span>
        <a class="ticket-change-link" href="#comment:15">comment:15</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>This is veering very close to <a href="/ticket/11795">#11795</a>. I'm inclined to consider the behavior valuable, but even more important is being clear about what we do.</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

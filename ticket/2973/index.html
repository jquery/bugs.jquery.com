<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#2973 (IE6 clone(true) bug when cloning a cloned element with events) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/2972/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/2974/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#2973</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(fixed)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened June 03, 2008 06:02PM UTC</p>
      
        <p>Closed February 14, 2009 05:21PM UTC</p>
      
      
        <p>Last modified March 14, 2012 05:06PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">IE6 clone(true) bug when cloning a cloned element with events</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        futileohm
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        major
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/1.3.2">1.3.2</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>core</td>
      
        <th>Version:</th>
      
      <td>1.3.1</td>
    </tr>
    <tr>
      
        <th>Keywords:</th>
      
      <td>clone ie6</td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>I seem to have discovered an obscure bug in IE (6, I don't have a copy of 7 to test with) when using </p><pre class="wiki">clone(true)</pre> that occurs when you clone an element with certain nested elements and events, and then clone it again. This is a regression from 1.2.3, which seems to have worked fine.<p></p><p>I had a hard time generalizing this bug as it seems to only happen in very specific circumstances, but I have attached a test case to demonstrate the behavior.</p><p>As far as I can tell, the most generic way to make the bug occur is to take a DOM node structured like so:</p><pre class="wiki">
&lt;div class='a'&gt;
	&lt;span&gt;
		&lt;span class='b'&gt;abc&lt;/span&gt;
	&lt;/span&gt;
	&lt;span&gt;
		&lt;span class='c'&gt;abc&lt;/span&gt;
	&lt;/span&gt;
&lt;/div&gt;
</pre><p>and bind an event to </p><pre class="wiki">span.b</pre> and another event to <pre class="wiki">span.c</pre>. Then, clone <pre class="wiki">div.a</pre> using <pre class="wiki">clone(true)</pre>, and then clone the clone using <pre class="wiki">clone(true)</pre> again. Removing any of the surrounding <pre class="wiki">span</pre> elements causes the bug to disappear, although swapping the class designation on the first set of nested <pre class="wiki">span</pre> elements demonstrates the bug as well.<p></p><p>The specific error reported by IE is "'nodeType' is null or not an object" and occurs on the first line of the </p><pre class="wiki">event.add</pre> function: <pre class="wiki">if ( elem.nodeType == 3 || elem.nodeType == 8 )</pre>.<p></p><p>I tried replacing the </p><pre class="wiki">event.add</pre> function in 1.2.3 with the <pre class="wiki">event.add</pre> function from the trunk, and 1.2.3 still doesn't demonstrate the bug, leading me to believe it's elsewhere that the issue's occurring. I compared the <pre class="wiki">clone</pre> functions from 1.2.3 and the trunk and didn't see any major changes that may have caused this sort of an issue, but at that point I was out of my league.<p></p><p>I'm not sure that this is a major regression, but it's a regression nonetheless, so I would imagine it should probably be fixed to maintain backwards compatibility.</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (3)</summary>

  <ul class="ticket-attachments">
    
      <li>
        <a href="/attachment/ticket/2973/clone-testcase.html/index.html">clone-testcase.html</a> (1.1 KB) - added by futileohm
        <strong>June 03, 2008 06:03PM UTC</strong>.<br>
        <p>Test case demonstrating the bug.</p>
      </li>
    
      <li>
        <a href="/attachment/ticket/2973/ie6-clone-events-patch.diff/index.html">ie6-clone-events-patch.diff</a> (1.2 KB) - added by futileohm
        <strong>June 05, 2008 06:29PM UTC</strong>.<br>
        <p>Actual patch with potential fix.</p>
      </li>
    
      <li>
        <a href="/attachment/ticket/2973/prism.exe/index.html">prism.exe</a> (104.0 KB) - added by futileohm
        <strong>June 05, 2008 06:27PM UTC</strong>.<br>
        <p>Patch with potential fix.</p>
      </li>
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (6)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed June 04, 2008 03:46PM UTC by <span class="author">flesler</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>You're trying this with 1.2.5 or 1.2.6 ?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed June 04, 2008 04:45PM UTC by <span class="author">futileohm</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>It doesn't work in 1.2.5, 1.2.6, or the latest trunk (r5712). (I think I chose version 1.2.5 because it was the latest listed at the time).</p><p>I can also confirm that the same bug occurs in IE7.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed June 05, 2008 06:37PM UTC by <span class="author">futileohm</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>(Apologies for the prism.exe attachment, I have no clue how that got selected instead of the patch itself, please delete it.)</p><p>I tracked down the source of the bug, and the actual cause is due to the way expandos are handled and stripped within the clone function. The actual change in behavior between 1.2.3 and the current trunk is due to a </p><pre class="wiki">unique()</pre> call within the <pre class="wiki">add()</pre> function. Within the clone function, the following is used to strip expandos from the newly cloned object:<p></p><pre class="wiki">
var clone = ret.find("*").andSelf().each(function(){
	if ( this[ expando ] != undefined )
		this[ expando ] = null;
});
</pre><p>However, the </p><pre class="wiki">andSelf()</pre> call, which then invokes <pre class="wiki">add()</pre>, barfs because of the yet-to-be-cleaned expandos on the newly cloned elements. Thus, until the expandos are cleaned, <pre class="wiki">unique()</pre> will return an incorrect set of elements because the copied expandos are inconsistent.<p></p><p>I attached a patch (against r5713) with a fix, which breaks the expando cleaning out into two separate calls to avoid using </p><pre class="wiki">andSelf()</pre>. There's probably a more efficient way of doing it, but I couldn't find one that wasn't incredibly tedious in my few minutes of tinkering. The new code looks like this:<p></p><pre class="wiki">
ret.find('*').each(function(){
	if ( this[ expando ] != undefined )
		this[ expando ] = null;
});

ret.each(function(){
	if ( this[ expando ] != undefined )
		this[ expando ] = null;
});

var clone = ret.find('*').andSelf();
</pre><p>As such, it seems this may not apply only to elements with events, but any data carrying nodes that are cloned within IE could be susceptible to this bug, which could in theory remove elements from the cloned set.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 25, 2008 08:43PM UTC by <span class="author">num</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:3 futileohm]:</p><p>Applied your patch to 1.2.6 and works well in prelim testing with <a href="http://plugins.jquery.com/project/jCal" class="ext-link"><span class="icon"></span>http://plugins.jquery.com/project/jCal</a> plugin which suffered from this issue.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed January 20, 2009 03:30PM UTC by <span class="author">dmethvin</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>keywords:</th>
                  <td>
                    
                      <span class="change-field-new">→ clone ie6</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              
            </div>
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed February 14, 2009 05:21PM UTC by <span class="author">john</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>milestone:</th>
                  <td>
                    
                      <span class="change-field-new">→ 1.3.2</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ fixed</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>version:</th>
                  <td>
                    
                      <span class="change-field-old">1.2.5</span> → <span class="change-field-new">1.3.1</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>This should be fixed now in SVN trunk.</p>
            </div>
          
        
          
        
          
        
          
        
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#4849 (stop() and multiple timers/queue collisions?) - jQuery - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jquery.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/SEeiGkT-TJ.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery issues have moved to <a href="https://github.com/jquery/jquery/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery Home">
            <img src="/img/logo.svg" width="215" alt="jQuery: Write Less, Do More.">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery active">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery Core navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jquery.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://api.jquery.com/">
                    Documentation
                  </a>
                </li>
                <li class="jq-tutorials">
                  <a href="https://learn.jquery.com/">
                    Tutorials
                  </a>
                </li>
                <li class="jq-bugTracker">
                  <a href="https://github.com/jquery/jquery/issues">
                    Bug Tracker
                  </a>
                </li>
                <li class="jq-discussion">
                  <a href="https://forum.jquery.com/">
                    Discussion
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <div id="bug-tracker-form" class="flex-column flex-between-center">
          <h1>Bug Tracker</h1>
          <div id="search"></div>
          
        </div>
      </header>
      <main id="skip" class="flex-column">
        <h2 class="visually-hidden">Side navigation</h2>
        <nav id="jq-sidenav" class="flex-column white-box">
          <h5 class="sidenav-header">Bug Tracker</h5>
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="white-box">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/4848/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/4850/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h3>
      <a href="" class="ticket-number">#4849</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(fixed)</span>
    </h3>

    <div class="ticket-dates">
      <p>Opened July 03, 2009 07:21PM UTC</p>
      
        <p>Closed April 17, 2011 07:43PM UTC</p>
      
      
        <p>Last modified May 09, 2011 02:32PM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">stop() and multiple timers/queue collisions?</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        Joust
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        low
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/1.next">1.next</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>effects</td>
      
        <th>Version:</th>
      
      <td>1.4.4</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>Hello!</p><p>Below is a test case extrapolatet from a more complex case.</p><p>After clicking the START button, all squares should dissapear, then the first one should reappear. It will not do it, because of .stop() on other 3 squares (!?).</p><p><a href="/wiki/FadeIn">FadeIn</a> animation of first square will hang.</p><pre class="wiki">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt; 
&lt;head&gt;
	&lt;title&gt;Timers bug&lt;/title&gt;
	&lt;script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"&gt;&lt;/script&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
	&lt;script type="text/javascript"&gt;
		$(function(){
			$('#btn').click(function(){
				$('#a').fadeTo('fast',0,function(){
					
					// The below will not work
					$('#a').fadeTo('fast',1);
				});
				$('#b').fadeTo('fast',0,function(){
					$('#b').stop(true,false);
					$('#c').stop(true,false);
					$('#d').stop(true,false);
				});
				$('#c').fadeTo('fast',0);
				$('#d').fadeTo('fast',0);
			});
			
			$('#btn2').click(function(){
				$('#a').queue([]).css({opacity:1});
				$('#b').queue([]).css({opacity:1});
				$('#c').queue([]).css({opacity:1});
				$('#d').queue([]).css({opacity:1});
			})
			
		});
	&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div id="a" style="background:red;width:100px;height:100px"&gt;&lt;/div&gt;
	&lt;div id="b" style="background:green;width:100px;height:100px"&gt;&lt;/div&gt;
	&lt;div id="c" style="background:blue;width:100px;height:100px"&gt;&lt;/div&gt;
	&lt;div id="d" style="background:yellow;width:100px;height:100px"&gt;&lt;/div&gt;
	&lt;button type="button" id="btn"&gt;START&lt;/button&gt;
	&lt;button type="button" id="btn2"&gt;RESET&lt;/button&gt;
&lt;/body&gt;


</pre></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (1)</summary>

  <ul class="ticket-attachments">
    
      <li>
        <a href="/attachment/ticket/4849/bug_4849_example_patch.zip/index.html">bug_4849_example_patch.zip</a> (40.5 KB) - added by gregory80
        <strong>October 14, 2009 09:26PM UTC</strong>.<br>
        <p>patch for use case of incorrect scope</p>
      </li>
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (8)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed July 03, 2009 07:31PM UTC by <span class="author">Joust</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>It will also work with only two squares, but the behaviour varies between FF, IE and Safari. I couldn't capture it in this example, but I have an app that works with multiple effects and it seems to work quite well under IE+Safari, but is broken under FF. It might be related to the timing - order in which timer-attached functions (i.e. fx.step()) are fired in different browsers when the timer difference is close to 10ms.</p><p>I'm sure that when you debug the above, you'll have a fix in no time. I've studied the calls fx makes to/from step(), queue(), dequeue() etc. but I don't see the flaw. </p><p>It might be related to the tight timeframe when a timer is popped/pushed from jQuery.timers array. Maybe when fx functions fire simultaneously in 2-3 instances (at the same time) the timers are not popped/pushed in the correct order?</p><p>Please take a look and fix it.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 14, 2009 09:26PM UTC by <span class="author">gregory80</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>After reviewing this bug, I believe this error is happening due to an element scope change issue.</p><p>In the above example, when the stop() method is executed, dequeue is being called from the stopped element. thus $('#b').get(0) === this. so this.dequeue() happens from the scope of id#b, but it needs to happen for $(#a) </p><p>However, in this case (as I imagine in all cases) dequeue needs to be called by the next element in the jQuery.timers queue, which is this scenario is $('#a').</p><p>There are several cases which can cause this issue to not surface. For instance, changing the speed of the original fadeTo() will keep this from surfacing:  $('#a').fadeTo('normal',0).fadeTo('fast',1);</p><p>Also, if $('#b').stop(true,false) is commented out, the scope issue doesn't arise.</p><p>I found that by altering the jQuery source code to call the next item in the timers array, this will always work.</p><p>on line 4699 of the nightly, changing </p><p>		&lt;code&gt;if (!gotoEnd)</p><p>			this.dequeue();&lt;/code&gt;</p><p>to </p><p>		&lt;code&gt;if (!gotoEnd)</p><p>			jQuery(timers.shift()).dequeue();&lt;/code&gt;</p><p>however, this is far from elegant in my eyes.</p><p>Please see my attached example and a patched version of jQuery that contains the above noted alteration of the jQuery core.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed November 21, 2010 01:06AM UTC by <span class="author">snover</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>milestone:</th>
                  <td>
                    
                      <span class="change-field-old strikethrough">1.4</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>priority:</th>
                  <td>
                    
                      <span class="change-field-old">critical</span> → <span class="change-field-new">low</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">open</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>version:</th>
                  <td>
                    
                      <span class="change-field-old">1.3.2</span> → <span class="change-field-new">1.4.4</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p><a href="http://www.jsfiddle.net/snover/Qqbs7/" class="ext-link"><span class="icon"></span>test case</a></p>
            </div>
          
        
          
        
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed November 21, 2010 01:08AM UTC by <span class="author">snover</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
                <tr>
                  <th>blocking:</th>
                  <td>
                    
                      <span class="change-field-new">→ 6641</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 17, 2011 07:43PM UTC by <span class="author">timmywil</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>milestone:</th>
                  <td>
                    
                      <span class="change-field-new">→ 1.next</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ fixed</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">open</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Fixed.  <a href="http://jsfiddle.net/timmywil/Qqbs7/1/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/timmywil/Qqbs7/1/</a></p>
            </div>
          
        
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:6">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed May 09, 2011 02:30PM UTC by <span class="author">anonymous</span></span>
        <a class="ticket-change-link" href="#comment:6">comment:6</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p><a href="http://jsfiddle.net/timmywil/Qqbs7/1/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/timmywil/Qqbs7/1/</a></p><p>If you click "START" multiple times very fast - it'll hang</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:7">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed May 09, 2011 02:32PM UTC by <span class="author">kuchumovn@gmail.com</span></span>
        <a class="ticket-change-link" href="#comment:7">comment:7</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>However, if you remove all the .stop() functions, it won't hang:</p><p><a href="http://jsfiddle.net/Qqbs7/2/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/Qqbs7/2/</a></p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:8">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed October 09, 2011 08:49PM UTC by <span class="author">timmywil</span></span>
        <a class="ticket-change-link" href="#comment:8">comment:8</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
                <tr>
                  <th>blocking:</th>
                  <td>
                    
                      <span class="change-field-old strikethrough">6641</span>
                    
                  </td>
                </tr>
              
            
              
            
          </tbody>
        </table>
        
          
        
          
            <div class="ticket-comment-body">
              <p>(In <a href="/ticket/6641">#6641</a>) I've looked into this a bit and it does not seem related to toggling. I haven't been able to reproduce this with random clicks (meaning it has not gotten stuck in the middle for me), only when the calls are in direct succession.  That leads me to believe it has something to do with the timer on the animation itself, or perhaps the asynchronous call in the mark deferred.  Reopening so we can dig in further.</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>
